var J=Object.defineProperty;var K=(a,e,t)=>e in a?J(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var c=(a,e,t)=>(K(a,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();class E{constructor(e){this.subscribers=e}changeSubscribers(e){this.subscribers=e}notify(){this.subscribers.forEach(e=>e.receive())}}class y{constructor(e="compassSpotTemplateFrame"){c(this,"frameElement");c(this,"frameElementDocument");this.id=e;const t=document.getElementById(e);t!=null&&(t==null?void 0:t.nodeName)==="IFRAME"?this.frameElement=t:(this.frameElement=this.createTemplateFrameElement(),document.body.appendChild(this.frameElement));do this.frameElementDocument=this.frameElement.contentDocument;while(this.frameElement.contentDocument==null)}selectElement(e){return this.frameElementDocument.getElementById(e)}selectWindow(){return this.frameElement.contentWindow}createTemplateFrameElement(){const e=document.createElement("iframe");return e.id=this.id,e.setAttribute("allowFullScreen","true"),e.setAttribute("allowTransparency","true"),e.setAttribute("border",""),e.style.border="0",e}writeContents(e){this.frameElementDocument.open();const t=`${e.html||""}${e.css||""}${e.js||""}`;this.frameElementDocument.write(`<html><head></head><body>${t}</body></html>`),this.frameElementDocument.close(),this.frameElementDocument.body.style.margin="0"}hideFrameElement(){this.updateStyles({display:"none"})}updateStyles(e){Object.entries(e).forEach(([t,i])=>{t in this.frameElement.style&&(this.frameElement.style[t]=i)})}deleteAllBodyChildrenElements(){const{body:e}=this.frameElementDocument;for(;e.firstChild!=null;)e.removeChild(e.firstChild)}activeScroll(){this.frameElementDocument.body.removeEventListener("touchmove",this.preventDefault),this.frameElementDocument.body.removeEventListener("wheel",this.preventDefault)}inactiveScroll(){this.frameElementDocument.body.addEventListener("touchmove",this.preventDefault,{passive:!1}),this.frameElementDocument.body.addEventListener("wheel",this.preventDefault,{passive:!1})}preventDefault(e){e==null||e.preventDefault()}replaceText(e,t){const i=this.frameElementDocument.getElementById(e);i!=null&&(i.innerText=t)}}class M{constructor(){c(this,"templateFrameRepository");this.templateFrameRepository=new y}receive(){this.templateFrameRepository.hideFrameElement(),this.templateFrameRepository.activeScroll()}}class V{executeRequest(e){const t="https://s-rtb.send.microad.jp/ad",i=e?`${t}?${e}`:t;this.sendRequestByJSONP(i)}sendRequestByJSONP(e){var r;const t=document.getElementsByTagName("script")[0],i=document.createElement("script");return i.type="text/javascript",i.defer=!0,i.src=e,(r=t.parentNode)==null||r.insertBefore(i,t),i}}class H{constructor(e,t,i){c(this,"adRequestRepository");c(this,"templateFrameRepository");this.adRequest=e,this.adResponse=t,this.selectedAudienceIds=i,this.adRequestRepository=new V,this.templateFrameRepository=new y}receive(){const e=this.adResponse.getRotationMax(),t=this.adResponse.getSequence();if(e==null||t==null)throw new Error("[COMPASS-JS] Cant read rotation_max or sequence. therefore, next advertisement is not display.");if(!this.adResponse.isExecutableRotation()){this.templateFrameRepository.hideFrameElement();return}if(this.adRequest.getEncryptedSpotId()==null)return;const i=this.adResponse.createRotationParams();this.adRequestRepository.executeRequest(this.adRequest.createRequestURL(i,this.selectedAudienceIds))}}class g{getStyle(e,t){return e.style[t]}createFrameElement(e,t){const i=document.createElement("iframe");return i.id=e,i.setAttribute("allowFullScreen","true"),i.setAttribute("allowTransparency","true"),i.setAttribute("border",""),i.style.border="0",t!=null&&t.width&&(i.style.width=`${t.width}px`),t!=null&&t.height&&(i.style.height=`${t.height}px`),i}writeIFrameContents(e,t,i){const r=this.getContentDocument(e);r.open();const s='<body style="margin: 0; width: fit-content; height: fit-content; overflow: hidden;">',n=`${t.html||""}${t.css||""}${t.js||""}`;r.write(`<html><head></head>${s}${n}</body></html>`),r.close(),i&&(r.body.style.minWidth="200px"),this.inactiveScroll(r)}observeIframeContentSize(e){const t=this.getContentDocument(e);new ResizeObserver(()=>{e.style.width=`${t.body.offsetWidth}px`,e.style.height=`${t.body.offsetHeight}px`}).observe(t.body)}append(e,t){e.appendChild(t)}appendSameElement(e,t,i){Object.keys([...Array(i)]).forEach(()=>{e.appendChild(document.createElement(t))})}addCssClass(e,t){e.className=t}removeAll(e){for(;e.firstChild!=null;)e.removeChild(e.firstChild)}clickBy(e){const t=this.getClickEventTargetElement(e);if(t==null)return;t.click()}inactiveClickOrTouch(e){e.style.pointerEvents="none"}updateStyles(e,t){e!=null&&Object.entries(t).forEach(([i,r])=>{i in e.style&&e.style[i]!=null&&(e.style[i]=r)})}activeFocusEvent(e,t,i){e.addEventListener("focus",t),e.addEventListener("blur",i)}inactiveFocusEvent(e,t,i){e.removeEventListener("focus",t),e.removeEventListener("blur",i)}activeTouchMoveEvent(e,t){e.addEventListener("touchmove",t)}inactiveTouchMoveEvent(e,t){e.removeEventListener("touchmove",t)}activeMovePageHistoryEvent(e,t,i){e.history.replaceState(null,"",null),e.addEventListener("pagehide",i),e.addEventListener("pageshow",t)}inactiveMovePageHistoryEvent(e,t,i){e.removeEventListener("pagehide",i),e.removeEventListener("pageshow",t)}getClickEventTargetElement(e){if(["a","A"].includes(e.nodeName))return e;let t;return Array.from(e.childNodes).forEach(i=>{t==null&&(t=this.getClickEventTargetElement(i))}),t}getContentDocument(e){let t;do t=e.contentDocument;while(e.contentDocument==null);return t}inactiveScroll(e){e.body.addEventListener("touchmove",this.preventDefault,{passive:!1}),e.body.addEventListener("wheel",this.preventDefault,{passive:!1})}preventDefault(e){e==null||e.preventDefault()}}class P{constructor(e,t){c(this,"templateRepository");c(this,"templateFrameRepository");c(this,"template");if(this.maybeTemplate=e,this.styleItems=t,e==null||!Object.values(e).length)throw new Error("[COMPASS-JS] Cant read spot template. therefore, advertisement is not display.");this.template=e,this.templateRepository=new g,this.templateFrameRepository=new y}rendering(){this.templateFrameRepository.writeContents(this.template),this.templateFrameRepository.updateStyles(this.styleItems),this.templateFrameRepository.inactiveScroll()}}const x={position:"fixed",zIndex:"6000000",top:"0",left:"0",width:"100%",height:"100%"};class j{constructor(e){c(this,"templateRepository");c(this,"templateFrameRepository");c(this,"rendering",(e,t)=>{if(e==null)return;const i=this.templateFrameRepository.selectElement(this.id);if(i==null)return;this.templateRepository.removeAll(i);const r=this.templateRepository.createFrameElement("compassSpotTemplateAdWrapper",t);this.templateRepository.append(i,r),this.templateRepository.writeIFrameContents(r,e,!t),t==null&&this.templateRepository.observeIframeContentSize(r),this.templateFrameRepository.selectElement("compassSpotTemplateAcceptButton")!=null&&this.templateRepository.inactiveClickOrTouch(i)});this.id=e,this.templateRepository=new g,this.templateFrameRepository=new y}}class Y{constructor(e,t){c(this,"templateRepository");c(this,"templateFrameRepository");this.id=e,this.adResponse=t,this.templateRepository=new g,this.templateFrameRepository=new y}changeStorage(e){this.adResponse=e}rendering(){const e=this.templateFrameRepository.selectElement(this.id);if(e==null)return;const t=this.adResponse.getRotationMax();t!=null&&(this.templateRepository.appendSameElement(e,"div",t+1),this.receive())}receive(){const e=this.templateFrameRepository.selectElement(this.id);if(e==null)return;const t=this.adResponse.getSequence()?Number(this.adResponse.getSequence())-2:0;Array.from(e.children).forEach((i,r)=>{const s=`compassSpotTemplateRotation${t===r?"CurrentButton":"Button"}`;this.templateRepository.addCssClass(i,s)})}}class F{constructor(e,t){this.beacon=e,this.parentElement=t}fire(){const e=this.createBeaconWrapperElement();this.parentElement.appendChild(e),e.append(...this.beacon)}createBeaconWrapperElement(){const e=document.createElement("div");return e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.visibility="hidden",e}}class O{constructor(e){this.beacon=e}create(){switch(typeof this.beacon){case"string":return new F(this.convertFromString(this.beacon),document.body);default:return}}createByURL(){if(typeof this.beacon=="string"){const e=this.createImgBeacon(this.beacon);return new F(e?[e]:[],document.body)}if(Array.isArray(this.beacon)){const e=this.beacon.map(t=>this.createImgBeacon(t)).filter(t=>t!=null);return new F(e,document.body)}}convertFromString(e){const i=new DOMParser().parseFromString(e,"text/html");return i.documentElement.nodeName==="parsererror"?[]:Array.from(i.body.childNodes)}createImgBeacon(e){const t=document.createElement("img");return t.width=0,t.height=0,t.style.width="0px",t.style.height="0px",t.style.display="none",t.src=e,t}}class D{constructor(e,t,i,r,s,n,o){c(this,"maybeBeaconRepository");this.maybeMicroadCompassFrequency=t,this.adRequest=i,this.adTag=r,this.frequencyParams=s,this.targetElementId=n,this.isFirstViewing=o,this.maybeBeaconRepository=new O(e).create()}receive(){var e,t;this.adRequest!=null&&this.isFirstViewing&&((e=this.maybeMicroadCompassFrequency)==null||e.callRewardAcquisitionProcess(this.adRequest,this.adTag,this.frequencyParams,this.targetElementId)),(t=this.maybeBeaconRepository)==null||t.fire()}}class B{hideTemplate(){new M().receive()}}class G{constructor(e){c(this,"templateRepository");c(this,"templateFrameRepository");this.id=e,this.templateRepository=new g,this.templateFrameRepository=new y}receive(){const e=this.templateFrameRepository.selectElement(this.id);(e==null?void 0:e.contentDocument)!=null&&this.templateRepository.clickBy(e.contentDocument.body)}}class X{constructor(e){c(this,"ITUNES_REGEX",/https?:\/\/itunes\.apple\.com/);this.value=e}isTransitionByBlank(){return!(this.ITUNES_REGEX.test(this.value)||this.ITUNES_REGEX.test(decodeURIComponent(this.value)))}}class Q{constructor(e,t=[]){c(this,"beaconRepositoryFactory");this.url=e,this.beaconRepositoryFactory=new O(t)}receive(){var e;this.transitionToUrl(),(e=this.beaconRepositoryFactory.createByURL())==null||e.fire()}transitionToUrl(){if(new X(this.url).isTransitionByBlank())window.open(this.url);else if(window.top!=null)window.top.location.href=this.url;else throw new Error("[COMPASS-JS] Cant find window top. therefore, cant transition to url.")}}class Z{constructor(e){this.id=e}create(e){const t=e.getLandingPageUrl(),i=e.getClickTrackingUrls()||[];return t?new Q(t,i):new G(this.id)}}class W{constructor(e,t){c(this,"templateFrameRepository");c(this,"templateRepository");c(this,"closeButton");c(this,"remainingTimeText");c(this,"rewardedText");this.frequencyValue=e,this.frequencyParams=t,this.templateFrameRepository=new y,this.templateRepository=new g,this.closeButton={element:void 0,displayStyle:void 0},this.remainingTimeText={element:void 0,displayStyle:void 0},this.rewardedText={element:void 0,displayStyle:void 0}}getElementStyle(e){return e==null?{element:void 0,displayStyle:void 0}:{element:e,displayStyle:this.templateRepository.getStyle(e,"display")}}selectElements(){const e=this.templateFrameRepository.selectElement("compassSpotTemplateCloseButton");this.closeButton=this.getElementStyle(e);const t=this.templateFrameRepository.selectElement("compassSpotTemplateRemainingTimeText");this.remainingTimeText=this.getElementStyle(t);const i=this.templateFrameRepository.selectElement("compassSpotTemplateRewardedText");return this.rewardedText=this.getElementStyle(i),this}isExistRequiredElements(){return this.closeButton.element==null||this.remainingTimeText.element==null?void 0:this}hideElements(){this.templateRepository.updateStyles(this.remainingTimeText.element,{display:"none"}),this.templateRepository.updateStyles(this.rewardedText.element,{display:"none"})}rewardedCallback(){this.templateRepository.updateStyles(this.remainingTimeText.element,{display:"none"}),this.templateRepository.updateStyles(this.closeButton.element,{display:this.closeButton.displayStyle}),this.templateRepository.updateStyles(this.rewardedText.element,{display:this.rewardedText.displayStyle})}replaceRemainingTimeMacro(e){this.templateFrameRepository.replaceText("compassSpotTemplateRemainingTime",e.toString())}execute(){const{rewardedSec:e}=this.frequencyParams;if(e===0){this.rewardedCallback();return}this.templateRepository.updateStyles(this.closeButton.element,{display:"none"}),this.templateRepository.updateStyles(this.rewardedText.element,{display:"none"}),this.replaceRemainingTimeMacro(this.frequencyParams.rewardedSec),this.frequencyValue.getRemainingTimeSync(this.frequencyParams.rewardedSec,this.replaceRemainingTimeMacro.bind(this),this.rewardedCallback.bind(this))}}class z extends B{constructor(t,i,r,s){if(!(r!=null&&r.html))throw new Error("[COMPASS-JS] Cant find template's HTML. therefore, advertisement is not display.");super();c(this,"closeClickEvent");c(this,"acceptClickEvent");c(this,"cancelClickEvent");c(this,"frame");c(this,"ad");c(this,"pager");this.microadCompass=s,this.frame=new P(r,x),this.ad=new j("compassSpotTemplateMain"),this.pager=new Y("compassSpotTemplateRotationContainer",i);const{adRotator:n,elementHider:o,clickThroughPlayer:l}=this.generateSubscribers(t,i);this.closeClickEvent=new E([o]),this.acceptClickEvent=new E([l,n]),this.cancelClickEvent=new E([n])}rendering(t,i){this.frame.rendering(),this.ad.rendering(i.getAd(),i.getSize()),this.pager.rendering();const r=this.microadCompass.selectMicroadCompassFrequency();this.fireImpressionBeacon(i.getImpressionTag(),r,t,i,!0);const s=i.getFrequencyParams();if(s==null)return;const n=this.microadCompass.selectMicroadCompassFrequency().getCustomKeyValues(t,s.key),o=this.microadCompass.selectMicroadCompassFrequency().selectFrequency(i.getEncryptedSpotId(),n||{},s.domain);if(o==null)throw new Error("[COMPASS-JS] Cant find registered frequency. therefore, advertisement is not display.");const l=new W(o,s);l.selectElements().isExistRequiredElements()?l.execute():l.hideElements()}reRendering(t,i,r){const{adRotator:s,elementHider:n,clickThroughPlayer:o}=this.generateSubscribers(i,r);this.closeClickEvent.changeSubscribers([n]),this.acceptClickEvent.changeSubscribers([o,s]),this.cancelClickEvent.changeSubscribers([s]),this.pager.changeStorage(r),this.ad.rendering(t,r.getSize()),this.pager.receive();const l=this.microadCompass.selectMicroadCompassFrequency();this.fireImpressionBeacon(r.getImpressionTag(),l,i,r,!1)}generateSubscribers(t,i){const r=new H(t,i,this.microadCompass.selectAudienceIds()),s=new M,n=new Z("compassSpotTemplateAdWrapper").create(i);return{adRotator:r,elementHider:s,clickThroughPlayer:n}}fireImpressionBeacon(t,i,r,s,n){new D(t,i,r,s==null?void 0:s.getAd().html,s==null?void 0:s.getFrequencyParams(),"compassSpotTemplateFrame",n).receive()}}const q={rendering:(a,e,t,i)=>{var n;const r=new z(e,t,t.getTemplate("main"),i);i.registerTemplateByImpression(a,"main",r);const s=(n=i.selectTemplate(a))==null?void 0:n.main;s!=null&&s.rendering(e,t)},reRendering:(a,e,t)=>{a.reRendering(t.getAd(),e,t)}};class ee{constructor(e,t,i,r,s=new y){this.adRequest=e,this.adResponse=t,this.microadCompassTemplate=i,this.templateRender=r,this.templateFrameRepository=s}receive(){this.templateFrameRepository.deleteAllBodyChildrenElements(),this.templateRender(this.adResponse.getImpressionId(),this.adRequest,this.adResponse,this.microadCompassTemplate)}}class te extends B{constructor(t,i,r,s){if(!(r!=null&&r.html))throw new Error("[COMPASS-JS] Cant find template's HTML. therefore, advertisement is not display.");super();c(this,"acceptClickEvent");c(this,"frame");this.microadCompass=s,this.frame=new P(r,x);const n=this.generateSubscribe(t,i);this.acceptClickEvent=new E([n])}generateSubscribe(t,i){return new ee(t,i,this.microadCompass,q.rendering)}rendering(){this.frame.rendering()}}const ie={rendering:(a,e,t,i)=>{var n;const r=new te(e,t,t.getTemplate("confirm"),i);i.registerTemplateByImpression(a,"confirm",r);const s=(n=i.selectTemplate(a))==null?void 0:n.confirm;s!=null&&s.rendering()}};class re{constructor(e,t,i,r,s,n,o,l,h,u,d,p,f,v,T,L,_,$,N,U){this.spot=e,this.callback=t,this.url=i,this.urlMacro=r,this.referrer=s,this.referrerMacro=n,this.ifa=o,this.appId=l,this.geo=h,this.vo=u,this.mimes=d,this.rtus=p,this.audiences=f,this.clientCints=v,this.cashBuster=T,this.protectedAudience=L,this.attributionReporting=_,this.version=$,this.fc=N,this.kvSet=U}getEncryptedSpotId(){return this.spot}createRequestURL(e,t){const i={spot:this.spot,cb:this.callback,url:this.url,url_macro:this.urlMacro,referrer:this.referrer,referrer_macro:this.referrerMacro,ifa:this.ifa,appid:this.appId,geo:this.geo,vo:this.vo,mimes:this.mimes,rtus:this.rtus,aids:[...t],ch:this.clientCints,cbt:this.cashBuster,pa:this.protectedAudience,ar:this.attributionReporting,ver:this.version,fc:this.fc};return Object.entries({...i,...e}).reduce((s,[n,o])=>(o instanceof(Object||Array)?Object.keys(o).length>0&&s.push(this.encodeURIParameter(n,JSON.stringify(o))):o&&s.push(this.encodeURIParameter(n,o)),s),[]).join("&")}createFrequencyCustomKeyParameters(e){if(this.kvSet==null)return{};const t=Object.entries(this.kvSet);return e.reduce((i,r)=>{var n;const s=(n=t.find(([o,l])=>o===r))==null?void 0:n[1];return s!=null&&(i[r]=s),i},{})}encodeURIParameter(e,t){return`${e}=${encodeURIComponent(t)}`}}class I{of(e){return new re(e.spot,e.cb,e.url,e.url_macro,e.referrer,e.referrer_macro,e.ifa,e.appid,e.geo,e.vo,e.mimes,e.rtus,e.aids,e.ch,e.cbt,e.pa,e.ar,e.ver,e.fc,e.kv_set)}}const m=class m{static convertDomain(e,t=new URL(document.URL)){if(e==="")throw new Error("[COMPASS-JS] Invalid domain. therefore, advertisement is not display.");const i=e.replace("{","").replace("}","");if(i==="FQDN")return t.host;const r=Number(i);return Number.isInteger(r)?m.createTopLevelDomainPlusAny(r):e}static createTopLevelDomainPlusAny(e,t=new URL(document.URL).hostname){if(e<1)throw new Error("[COMPASS-JS] Number of domain pattern is less than 1. therefore, advertisement is not display.");const i=m.createTopLevelDomainPlusOne(t);if(e===1)return i;const r=t.replace(i,"").split(".").slice(-e).join(".");return r?`${r}${i}`:i}static createTopLevelDomainPlusOne(e=new URL(document.URL).hostname){const t=e.split(".");for(let i=2;i<=t.length;i+=1){const r=t.slice(-i).join(".");if(document.cookie=this.createCookie(r),m.isExist(m.testCookieName))return document.cookie=this.createCookie(r,0),r}return e}static createCookie(e,t=m.testExpireSeconds){return`${`${m.testCookieName}=${m.testValue}`}; domain=${e}; path=/; max-age=${t}`}static isExist(e){return document.cookie.split(";").map(t=>{const[i,r]=t.split("=");return{key:i.trim(),value:r}}).some(t=>t.key===e)}};c(m,"testCookieName","mtcn"),c(m,"testValue","mtcnv"),c(m,"testExpireSeconds",10);let w=m;class b{constructor(e,t,i,r,s,n,o,l,h,u,d,p){this.impressionId=e,this.encryptedSpotId=t,this.creativeType=i,this.templates=r,this.width=s,this.height=n,this.sequence=o,this.rotationMax=l,this.aspectRatioId=h,this.advertiserDomain=u,this.displayedIds=d,this.frequency=p}getImpressionId(){return this.impressionId}getEncryptedSpotId(){return this.encryptedSpotId}getTemplate(e){return this.templates?this.templates[e]:void 0}getSize(){const e=this.width!=null&&this.width>0,t=this.height!=null&&this.height>0;return e&&t?{width:this.width,height:this.height}:void 0}getSequence(){return this.sequence}getRotationMax(){return this.rotationMax==null?void 0:this.rotationMax}isExecutableRotation(){const e=this.getRotationMax(),t=this.getSequence();return e==null||t==null?!1:e+1>=t}createRotationParams(){return{impression_id:this.impressionId,creative_type:this.creativeType,sequence:String(this.sequence),aspect_ratio_id:this.aspectRatioId,adomains:this.advertiserDomain?JSON.parse(this.advertiserDomain)||[]:void 0,displayed_ids:this.displayedIds,frequency:this.frequency}}getFrequencyParams(){if(this.frequency!=null)return{key:this.frequency.key,domain:w.convertDomain(this.frequency.domain),rewardedSec:this.frequency.rewarded_sec}}}class se extends b{constructor(e,t,i,r,s,n,o,l,h,u,d,p,f){super(e,i,r,o,void 0,void 0,l,h,u,d,p,f),this.impressionTag=t,this.encryptedSpotId=i,this.adTag=s,this.nativeCss=n}getAd(){return{html:this.adTag,css:this.nativeCss,js:""}}getImpressionId(){return this.impressionId}getEncryptedSpotId(){return this.encryptedSpotId}getImpressionTag(){return this.impressionTag}getLandingPageUrl(){}getClickTrackingUrls(){}}class ne extends b{constructor(e,t,i,r,s,n,o,l,h,u,d,p,f,v){super(e,i,r,n,o,l,h,u,d,p,f,v),this.impressionTag=t,this.adTag=s}getAd(){return{html:this.adTag,css:"",js:""}}getImpressionTag(){return this.impressionTag}getLandingPageUrl(){}getClickTrackingUrls(){}}class oe extends b{constructor(e,t,i,r,s,n,o,l,h,u,d,p,f,v,T){super(e,t,i,s,n,o,l,h,u,d,p,T),this.adTag=r,this.landingPageUrl=f,this.clickTrackingUrls=v}getAd(){return{html:this.adTag,css:"",js:""}}getImpressionTag(){}getLandingPageUrl(){return this.landingPageUrl}getClickTrackingUrls(){return this.clickTrackingUrls}}class k{of(e){var l;const t=this.validateImpressionId(e.impression_id),i=this.validateSpotId(e.spot),r=this.validateSequence(e.sequence),s=this.validateRotationMax(e.rotation_max,e.adtag);if(e.frequency&&this.isCollectFrequencyParams(e.frequency),!e.adtag)return;const n=e.width!=null?Number(e.width):void 0,o=e.height!=null?Number(e.height):void 0;switch(e.creative_type){case"banner":return new ne(t,e.imptag,i,e.creative_type,e.adtag,e.templates,n,o,r,s,e.aspect_ratio_id,e.adomains,e.displayed_ids,e.frequency);case"native":return new se(t,e.imptag,i,e.creative_type,e.adtag,e.nativecss,e.templates,r,s,e.aspect_ratio_id,e.adomains,e.displayed_ids,e.frequency);case"video":return this.validateClickThroughUrl(e),new oe(t,i,e.creative_type,e.adtag,e.templates,n,o,r,s,e.aspect_ratio_id,e.adomains,e.displayed_ids,e.ext.click_through_url,((l=e.ext)==null?void 0:l.click_tracking_urls)||[],e.frequency);default:return}}validateImpressionId(e){if(e==null)throw new Error("[COMPASS-JS] Cant find impression_id. therefore, advertisement is not display.");return e}validateSpotId(e){if(e==null)throw new Error("[COMPASS-JS] Cant find spot. therefore, advertisement is not display.");return e}validateClickThroughUrl(e){var t;if(e.creative_type!=="video")return"";if(!((t=e.ext)!=null&&t.click_through_url))throw new Error("[COMPASS-JS] Cant find click_through_url. therefore, advertisement is not display.");return e.ext.click_through_url}validateSequence(e){if(e==null)throw new Error("[COMPASS-JS] Cant find sequence. therefore, advertisement is not display.");const t=Number(e);if(Number.isNaN(t))throw new Error("[COMPASS-JS] adResponse.sequence is invalid. therefore, advertisement is not display.");return t}validateRotationMax(e,t){if(e==null){if(t==null)return;throw new Error("[COMPASS-JS] Cant find rotation_max. therefore, advertisement is not display.")}const i=Number(e);if(Number.isNaN(i))throw new Error("[COMPASS-JS] adResponse.rotation_max is invalid. therefore, advertisement is not display.");return i}getFrequencyParam(e){if(this.validateImpressionId(e.impression_id),this.validateSpotId(e.spot),this.validateSequence(e.sequence),this.validateRotationMax(e.rotation_max,e.adtag),this.validateClickThroughUrl(e),e.frequency!=null)return this.isCollectFrequencyParams(e.frequency),{key:e.frequency.key,domain:w.convertDomain(e.frequency.domain),rewardedSec:Number(e.frequency.rewarded_sec)}}isCollectFrequencyParams(e){if(e.key==null)throw new Error("[COMPASS-JS] Cant find frequency.key. therefore, advertisement is not display.");if(e.domain==null)throw new Error("[COMPASS-JS] Cant find frequency.domain. therefore, advertisement is not display.");if(e.rewarded_sec==null)throw new Error("[COMPASS-JS] Cant find frequency.rewarded_sec. therefore, advertisement is not display.");if(e.domain==="")throw new Error("[COMPASS-JS] Invalid domain. therefore, advertisement is not display.");const t=Number(e.domain.replace("{","").replace("}",""));if(Number.isInteger(t)&&t<1)throw new Error("[COMPASS-JS] Number of domain pattern is less than 1. therefore, advertisement is not display.");const i=Number(e.rewarded_sec),r=Number.isNaN(i)?void 0:i;if(r==null)throw new Error("[COMPASS-JS] frequency.rewarded_sec is NaN. therefore, advertisement is not display.");if(r<0)throw new Error("[COMPASS-JS] frequency.rewarded_sec is negative. therefore, advertisement is not display.");return!0}}class ae{constructor(e){c(this,"adResponseAdapter");c(this,"adRequestAdapter");this.microadCompass=e,this.adRequestAdapter=new I,this.adResponseAdapter=new k}renderingAnyTemplate(e,t){var o;const i=t.getImpressionId(),r=(o=this.microadCompass.selectTemplate(i))==null?void 0:o.main,s=t.getTemplate("main"),n=t.getTemplate("confirm");if(r!=null)q.reRendering(r,e,t);else if(n!=null&&s!=null)ie.rendering(i,e,t,this.microadCompass);else if(s!=null)q.rendering(i,e,t,this.microadCompass);else throw new Error("[COMPASS-JS] Cant find required template's HTML. therefore, advertisement is not display.")}hideTemplate(e){if(e.impression_id==null)return;const t=this.microadCompass.selectTemplate(e.impression_id),i=t==null?void 0:t.main,r=t==null?void 0:t.confirm;i!=null&&i.hideTemplate(),r!=null&&r.hideTemplate()}rendering(e,t){var i;try{const r=this.adRequestAdapter.of(e),s=this.adResponseAdapter.of(t);s!=null?this.renderingAnyTemplate(r,s):(new D(t.imptag,this.microadCompass.selectMicroadCompassFrequency(),r,void 0,void 0,void 0,!((i=this.microadCompass.selectTemplate(t.impression_id))!=null&&i.main)).receive(),this.hideTemplate(t))}catch(r){throw this.hideTemplate(t),e.spot&&this.microadCompass.selectMicroadCompassFrequency().cancel(e.spot),new Error(r.message)}}}class ce{constructor(e,t={}){this.display=e,this.templates=t}selectDisplayFunc(){return this.display}selectTemplate(e){return this.templates[e]}registerTemplateByImpression(e,t,i){const r=this.templates[e];r!=null?this.templates[e]={...r,[t]:i}:this.templates[e]={[t]:i}}notify(e,t,i){var n;const r=(n=this.selectTemplate(e))==null?void 0:n[t];if(r==null){const o=`[COMPASS-JS] Cant find ${t} template's HTML. therefore, advertisement is not display.`;throw new Error(o)}const s=r[i];if(s==null)throw new Error("[COMPASS-JS] Cant find template's event. therefore, advertisement is not display.");s.notify()}}const C=class C{selectRelayData(e){return this.getCookiesFromBrowser().filter(t=>t.key===e).map(t=>{const i=JSON.parse(t.value);return{updateTime:i[0],frequencyCode:i[1]}})}selectFrequencyCode(e){return this.getCookiesFromBrowser().filter(t=>t.key===e).map(t=>{const i=JSON.parse(t.value);return{updateTime:i[0],counter:i[1],time:i[2]}})}registerRelayData(e,t,i){const r=new Date().getTime();this.writeCookie(e,`[${r}, "${t}"]`,i)}register(e){const t=e.getKey(),i=e.getCounter(),r=e.getRewardedTime(),s=new Date().getTime(),n=e.getDomain();n!=null&&this.writeCookie(t,`[${s}, ${i}, ${r}]`,n)}getCookiesFromBrowser(){var e;return document.cookie==null?[]:(e=document.cookie)==null?void 0:e.split(";").map(t=>{const[i,r]=t.split("=");return{key:i.trim(),value:r}})}writeCookie(e,t,i,r=C.cookieExpirationSec){document.cookie=`${e}=${t}; domain=${i}; max-age=${r}; path=/;`}};c(C,"cookieExpirationSec",604800);let S=C;class le{constructor(e,t=[]){c(this,"MARKER_TEMPORARY_ID","frequency-temporary");this.id=e,this.measures=t}start(){const e=this.measures.slice(-1)[0];if(e!=null&&e.finish==null)return;const t=this.getStartId(this.id,this.measures.length);this.measures.push({start:performance.mark(t),finish:void 0})}finish(){const e=this.measures.slice(-1)[0];if((e==null?void 0:e.start)==null)return;const t=this.measures.length-1,i=this.getFinishId(this.id,t);this.measures[t].finish=performance.mark(i)}getTotalDuration(e=void 0){const t=this.measures.length-1,i=this.measures.reduce((r,s,n)=>{const o=t===n;if(s.start==null||!o&&s.finish==null)return r;s.finish==null&&(performance.clearMarks(this.MARKER_TEMPORARY_ID),performance.mark(this.MARKER_TEMPORARY_ID,e==null?void 0:{startTime:e}));const l=performance.measure(this.getResultId(this.id,n),this.getStartId(this.id,n),o&&s.finish==null?this.MARKER_TEMPORARY_ID:this.getFinishId(this.id,n));return r+l.duration},0);return Math.round(i)}reset(){this.measures=[]}getStartId(e,t){return`${this.getCommonId(this.id,t)}-start`}getFinishId(e,t){return`${this.getCommonId(this.id,t)}-finish`}getResultId(e,t){return`${this.getCommonId(this.id,t)}-result`}getCommonId(e,t){return`${this.id}-${t}`}}class he{constructor(e,t,i,r,s,n=new S,o=!1){c(this,"measure");c(this,"clockId");c(this,"remainingTimeId");this.id=e,this.key=t,this.counter=i,this.rewardedTime=r,this.domain=s,this.frequencyRepository=n,this.isReachedReward=o,this.measure=new le(this.id),this.clockId=void 0,this.remainingTimeId=void 0}getKey(){return this.key}getCounter(){return this.counter}getRewardedTime(){return this.rewardedTime}getDomain(){return this.domain}countUp(e){this.counter+=1,this.frequencyRepository.registerRelayData(e,this.key,this.domain),this.frequencyRepository.register(this)}resetFrequency(e){this.counter=0,this.rewardedTime=Math.floor(new Date().getTime()/1e3),this.frequencyRepository.registerRelayData(e,this.key,this.domain),this.frequencyRepository.register(this)}reachReward(){this.isReachedReward=!0}getTotalDurationSec(){return Math.floor(this.measure.getTotalDuration()/1e3)}setTheClock(e,t,i){this.clockId=setInterval(()=>{this.clockId!=null&&(e>this.getTotalDurationSec()&&!this.isReachedReward||(this.resetFrequency(t),i(),clearInterval(this.clockId)))},1)}getRemainingTime(e){return e-this.getTotalDurationSec()}getRemainingTimeSync(e,t,i){let r=e;this.remainingTimeId=setInterval(()=>{if(this.remainingTimeId==null)return;const s=this.getRemainingTime(e);r!==s&&(r=s,t(s),!(s>0&&!this.isReachedReward)&&(i(),s<0&&t(0),clearInterval(this.remainingTimeId)))},1)}cancel(){this.clockId!=null&&(clearInterval(this.clockId),this.clockId=void 0),this.remainingTimeId!=null&&(clearInterval(this.remainingTimeId),this.remainingTimeId=void 0),this.measure.reset()}startTheClock(){this.measure.start()}finishTheClock(){this.measure.finish()}isEqual(e){return this.key===e}}const R={of:(a,e,t,i,r=0)=>new he(a,e,r,t,i)};class me{constructor(e,t,i=!1){c(this,"templateFrameRepository");c(this,"templateRepository");c(this,"targetWindow");c(this,"intersectionObserver");c(this,"inViewFunction");c(this,"outViewFunction");this.inViewRate=e,this.targetElement=t,this.isInviewing=i,this.inViewFunction=void 0,this.outViewFunction=void 0,this.templateFrameRepository=new y,this.templateRepository=new g}connect(e,t){e();const i=()=>{this.isInviewing=!0,this.isInviewing&&e()},r=()=>{this.isInviewing=!1,this.isInviewing||t()};this.inViewFunction=i,this.outViewFunction=r,this.targetWindow=this.templateFrameRepository.selectWindow(),this.setIntersectionObserver(i,r),this.targetWindow!=null&&this.setFocusObserver(this.targetWindow,i,r)}disconnect(){var i;if((i=this.intersectionObserver)==null||i.disconnect(),this.targetWindow==null||this.inViewFunction==null||this.outViewFunction==null)return;const e=this.inViewFunction,t=this.outViewFunction;this.removeFocusEventListener(this.targetWindow,e,t),this.removeTouchMoveEventListener(this.targetWindow,e),this.removeHistoryBackEventListener(this.targetWindow,e,t)}setIntersectionObserver(e,t){this.intersectionObserver=new IntersectionObserver((i,r)=>{const s=i.find(n=>n.target===this.targetElement);s!=null&&(s.intersectionRatio>=this.inViewRate?(this.isInviewing=!0,e()):(this.isInviewing=!1,t()))},{threshold:[this.inViewRate]}),this.intersectionObserver.observe(this.targetElement)}setFocusObserver(e,t,i){this.addFocusEventListener(e,t,i),this.addTouchMoveEventListener(e,t),this.addHistoryBackEventListener(e,t,i)}addFocusEventListener(e,t,i){this.templateRepository.activeFocusEvent(e,t,i),e!==e.top&&this.templateRepository.activeFocusEvent(e.parent,t,i)}addTouchMoveEventListener(e,t){this.templateRepository.activeTouchMoveEvent(e,t),e!==e.top&&this.templateRepository.activeTouchMoveEvent(e.parent,t)}addHistoryBackEventListener(e,t,i){this.templateRepository.activeMovePageHistoryEvent(e,t,i),e!==e.top&&this.templateRepository.activeMovePageHistoryEvent(e.parent,t,i)}removeFocusEventListener(e,t,i){this.templateRepository.inactiveFocusEvent(e,t,i),e!==e.top&&this.templateRepository.inactiveFocusEvent(e.parent,t,i)}removeTouchMoveEventListener(e,t){e.removeEventListener("touchmove",t),e!==e.top&&this.templateRepository.inactiveTouchMoveEvent(e.parent,t)}removeHistoryBackEventListener(e,t,i){e.removeEventListener("popstate",i),e!==e.top&&this.templateRepository.inactiveMovePageHistoryEvent(e.parent,t,i)}}const ue=.5,A=/\${[A-Za-z0-9]+}/g;class de{constructor(e=new S,t=void 0,i={}){c(this,"selectInsertFrequency",(e,t,i)=>{this.resetFrequencyData(e,t);const r=this.getCustomKeyValues(e,t.key),s=this.selectFrequency(i,r,t.domain);if(s==null)throw new Error("[COMPASS-JS] Cant find registered frequency cookies. therefore, advertisement is not display.");return s});this.frequencyRepository=e,this.viewableOperator=t,this.frequencies=i}getCustomKeyValues(e,t){const i=t.match(A);if(i==null)return{};const r=i.map(s=>s.replace(/^\${/,"").replace(/}$/,""));return e.createFrequencyCustomKeyParameters(r)}selectFrequencyCodeKey(e,t){const i=this.generateKeyForSpot(e),r=this.getFrequencyRelay(i);return r==null?void 0:this.generateKeyForFrequency(r.frequencyCode,t)}selectFrequencyCode(e,t){const i=this.selectFrequencyCodeKey(e,t);return i==null?void 0:this.getFrequencyCode(i)}selectFrequency(e,t,i){const r=this.selectFrequencyCodeKey(e,t);if(r==null)return null;const s=this.getFrequencyCode(r);if(s==null)return null;if(this.frequencies[e]==null){const o=R.of(`${e}-${Date.now()}-frequency`,r,s.time,i,s.counter);this.registerFrequencyByEncryptedSpotId(e,o)}return this.frequencies[e]}registerFrequencyData(e,t,i){const r=R.of(`${t}-${Date.now()}-frequency`,e,null,i.domain);this.frequencyRepository.register(r)}registerFrequencyByEncryptedSpotId(e,t){this.frequencies={...this.frequencies,[e]:t}}updateCounter(e,t){const i=new I().of(e),r=i.getEncryptedSpotId(),s=new k().getFrequencyParam(t);if(r==null||s==null)return;const n=this.getCustomKeyValues(i,s.key);let o=this.selectFrequency(r,n,s.domain);o==null&&(o=this.selectInsertFrequency(i,s,r));const l=this.generateKeyForFrequency(s.key,n);o.isEqual(l)||(o=this.selectInsertFrequency(i,s,r)),o.countUp(this.generateKeyForSpot(r))}notify(e,t,i){const r=new I().of(t),s=new k().of(i);this.callRewardAcquisitionProcess(r,s==null?void 0:s.getAd().html,s==null?void 0:s.getFrequencyParams(),e)}callRewardAcquisitionProcess(e,t,i,r){const s=e.getEncryptedSpotId();if(s==null||i==null)return;const n=this.frequencies[s];if(n==null)throw new Error("[COMPASS-JS] callRewardAcquisitionProcess() has to be called after it is called updateCounter().");const o=r==null?void 0:document.getElementById(r);t&&o&&n&&(this.viewableOperator=new me(ue,o),this.viewableOperator.connect(n.startTheClock.bind(n),n.finishTheClock.bind(n)),n.setTheClock(i.rewardedSec,this.generateKeyForSpot(s),this.viewableOperator.disconnect.bind(this.viewableOperator)))}cancel(e){var i;const t=this.frequencies[e];t!=null&&(t.cancel(),(i=this.viewableOperator)==null||i.disconnect())}resetFrequencyData(e,t){const i=e.getEncryptedSpotId();if(t==null||i==null)return;const r=this.generateKeyForSpot(i),s=this.getFrequencyRelay(r);(s==null||s.frequencyCode!==t.key)&&this.frequencyRepository.registerRelayData(r,t.key,t.domain);const n=this.getFrequencyRelay(r);if(n==null)return;const o=this.getCustomKeyValues(e,t.key),l=this.generateKeyForFrequency(n.frequencyCode,o);this.getFrequencyCode(l)==null&&this.registerFrequencyData(l,i,t);const h=this.getFrequencyCode(l),u=R.of(`${i}-${Date.now()}-frequency`,l,(h==null?void 0:h.time)??null,t.domain,h==null?void 0:h.counter);this.registerFrequencyByEncryptedSpotId(i,u)}generateKeyForSpot(e){return`_mafc_${e}`}getFrequencyRelay(e){const t=this.frequencyRepository.selectRelayData(e);return t.length===0?null:t.reduce((i,r)=>i.updateTime==null||r.updateTime>i.updateTime?r:i,{})}getFrequencyCode(e){const t=this.frequencyRepository.selectFrequencyCode(e);return t.length===0?null:t.reduce((i,r)=>i.updateTime==null||r.updateTime>i.updateTime?r:i,{})}generateKeyForFrequency(e,t){const i=e.match(A);return i==null?e:i.reduce((r,s)=>{const n=s.replace(/^\${/,"").replace(/}$/,""),o=t[n]==null?"":t[n];return o==null?r:r.replace(`${s}`,o)},e)}}class pe{readCookie(e){const i=this.readCookies().filter(r=>r.key===e);return i.length>0?i.slice(-1)[0].value:void 0}writeCookie(e,t,i,r){document.cookie=`${e}=${t}; domain=${i}; max-age=${r}; path=/;`}readCookies(){return document.cookie==null||document.cookie===""?[]:document.cookie.split(";").map(e=>{const[t,i]=e.split("=");return{key:(t==null?void 0:t.trim())||"",value:(i==null?void 0:i.trim())||""}})}}class ye{constructor(e="_unv_id",t=w.createTopLevelDomainPlusOne(),i=60*60,r=new pe){this.key=e,this.domain=t,this.maxAge=i,this.trackerRepository=r}write(e){this.trackerRepository.writeCookie(this.key,e,this.domain,this.maxAge)}read(){return this.trackerRepository.readCookie(this.key)}}class fe{constructor(e=new ye){this.universeIdTracker=e}write(e,t){switch(e){case 21:return t==null?void 0:(this.universeIdTracker.write(t),this.read(e));default:return}}read(e){switch(e){case 21:return this.universeIdTracker.read();default:return}}}class ge{constructor(){c(this,"microadCompass");const e=window;if(this.microadCompass=e.microadCompass==null?{ad:void 0,frequency:void 0,aids:[],audience:void 0}:e.microadCompass,e.microadCompass=this.microadCompass,!this.microadCompass.ad){const t=new ae(this);this.microadCompass.ad=new ce(t.rendering.bind(t))}this.microadCompass.frequency||(this.microadCompass.frequency=new de),this.microadCompass.audience||(this.microadCompass.audience=new fe)}selectDisplayFunc(){return this.microadCompass.ad.selectDisplayFunc()}selectTemplate(e){return this.microadCompass.ad.selectTemplate(e)}selectAudienceIds(){return this.microadCompass.aids||[]}selectMicroadCompassFrequency(){return this.microadCompass.frequency}registerTemplateByImpression(e,t,i){this.microadCompass.ad.registerTemplateByImpression(e,t,i)}}new ge;
